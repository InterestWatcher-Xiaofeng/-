# 🍁 红枫工具箱 V1.2.1 优化说明

## 📅 版本信息
- **版本号：** V1.2.1
- **发布日期：** 2025-10-30
- **更新类型：** 功能优化

---

## 🎯 本次优化重点

### 1. 详细进度条显示 ⭐ 核心优化

**优化前：**
```
状态栏：[2/5] 正在采集: 美食探店...
进度条：无实时更新
```

**优化后：**
```
状态栏：🔥 正在采集第3个视频: 探店美食推荐...
进度条：[2/5] 3/10 视频
进度百分比：30% (实时更新)
```

**功能特性：**
- ✅ 显示当前采集的视频序号（如：1/10）
- ✅ 显示当前视频标题（前20字）
- ✅ 进度条实时更新百分比
- ✅ 同时显示关键词组进度（如：[2/5]）
- ✅ 双层进度显示：组进度 + 视频进度

**技术实现：**
```python
# 进度回调函数
def progress_callback(current, total, message):
    progress = current / total if total > 0 else 0
    progress_text = f"[{current_index}/{total_groups}] {current}/{total} 视频"
    
    # 更新进度条
    self.progress_bar.set(progress)
    self.progress_text.configure(text=progress_text)
    self.update_status(f"🔥 {message}")
```

---

### 2. 文件命名规则优化 ⭐ 核心优化

**优化前：**
```
search_comments_美食探店_20251030_143052.csv
search_contents_美食探店_20251030_143052.csv
```

**优化后：**
```
抖音_美食探店_评论.csv
抖音_美食探店_内容.csv
```

**命名规则：**
```
格式：平台_关键词_类型.格式

平台：抖音、小红书、快手、B站、微博、贴吧、知乎
关键词：自动清理特殊字符，空格替换为下划线
类型：评论、内容、创作者、视频
格式：csv、json、db、sqlite
```

**示例：**
```
抖音_美食探店_评论.csv
抖音_旅游攻略_内容.csv
小红书_美妆护肤_评论.json
B站_科技数码_视频.csv
```

**优势：**
- ✅ 文件名更简洁易读
- ✅ 平台一目了然
- ✅ 关键词清晰可见
- ✅ 每组关键词一个文件，不会重复
- ✅ 不再有时间戳，避免文件过多

---

## 🔧 技术改进

### 1. 进度回调机制

**新增文件修改：**

#### `统一浏览器采集器.py`
```python
class UnifiedBrowserCrawler:
    def __init__(self, shared_context=None, shared_page=None, progress_callback=None):
        self.progress_callback = progress_callback  # 新增进度回调
        
    async def start_unified_douyin_crawling(self):
        # 传递进度回调给爬虫
        if self.progress_callback:
            self.crawler.progress_callback = self.progress_callback
```

#### `media_platform/douyin/core.py`
```python
class DouYinCrawler(AbstractCrawler):
    def __init__(self):
        self.progress_callback = None  # 新增进度回调属性
        
    async def search(self):
        # 在采集每个视频后更新进度
        if self.progress_callback:
            current = len(aweme_list)
            total = max_notes_to_collect
            title = aweme_info.get("desc", "")[:20]
            self.progress_callback(current, total, f"正在采集第{current}个视频: {title}...")
```

#### `gui_app.py`
```python
async def async_douyin_crawler(self, keywords, max_count, content_type, current_index, total_groups):
    # 定义进度回调函数
    def progress_callback(current, total, message):
        progress = current / total if total > 0 else 0
        progress_text = f"[{current_index}/{total_groups}] {current}/{total} {content_type}"
        
        # 在主线程中更新UI
        self.root.after(0, lambda: self.progress_bar.set(progress))
        self.root.after(0, lambda: self.progress_text.configure(text=progress_text))
        self.root.after(0, lambda: self.update_status(f"🔥 {message}"))
    
    # 传递进度回调
    await run_unified_crawler(..., progress_callback=progress_callback)
```

---

### 2. 文件命名逻辑优化

**新增文件修改：**

#### `tools/async_file_writer.py`
```python
def _get_file_path(self, file_type: str, item_type: str) -> str:
    # 获取关键词并清理特殊字符
    import config
    import re
    
    keywords = getattr(config, 'KEYWORDS', '')
    clean_keywords = re.sub(r'[\\/:*?"<>|\s]+', '_', keywords.strip())
    if not clean_keywords:
        clean_keywords = "未命名"
    
    # 平台名称映射
    platform_names = {
        "douyin": "抖音",
        "xhs": "小红书",
        "kuaishou": "快手",
        "bilibili": "B站",
        "weibo": "微博",
        "tieba": "贴吧",
        "zhihu": "知乎"
    }
    platform_name = platform_names.get(self.platform, self.platform)
    
    # 类型名称映射
    type_names = {
        "comments": "评论",
        "contents": "内容",
        "creators": "创作者",
        "videos": "视频"
    }
    type_name = type_names.get(item_type, item_type)
    
    # 新文件名格式：平台_关键词_类型.格式
    file_name = f"{platform_name}_{clean_keywords}_{type_name}.{file_type}"
    file_path = f"{base_path}/{file_name}"
    
    return file_path
```

---

## 📊 代码变更统计

### 修改文件
1. `统一浏览器采集器.py` - 添加进度回调支持
2. `media_platform/douyin/core.py` - 添加进度回调调用
3. `gui_app.py` - 实现进度回调函数
4. `tools/async_file_writer.py` - 优化文件命名逻辑
5. `version.py` - 更新版本号

### 变更行数
- 新增：约 60 行
- 修改：约 40 行
- 删除：约 10 行

---

## 🎯 使用示例

### 示例1：单组关键词采集

**输入：**
```
美食 探店
```

**配置：**
- 视频数量：10个
- 评论数量：50条
- 保存格式：CSV

**进度显示：**
```
状态栏：🔥 正在采集第1个视频: 成都美食探店推荐...
进度条：[1/1] 1/10 视频
进度：10%

状态栏：🔥 正在采集第2个视频: 重庆火锅探店...
进度条：[1/1] 2/10 视频
进度：20%

...

状态栏：🔥 正在采集第10个视频: 上海网红餐厅...
进度条：[1/1] 10/10 视频
进度：100%
```

**生成文件：**
```
✅ 抖音_美食_探店_评论.csv
✅ 抖音_美食_探店_内容.csv
```

---

### 示例2：批量关键词采集

**输入：**
```
美食 探店
旅游 攻略
科技 数码
```

**进度显示：**
```
[1/3] 正在采集: 美食 探店
  状态栏：🔥 正在采集第1个视频: 成都美食探店...
  进度条：[1/3] 1/10 视频
  进度：10%
  
  ...
  
  状态栏：🔥 正在采集第10个视频: 上海网红餐厅...
  进度条：[1/3] 10/10 视频
  进度：100%

[2/3] 正在采集: 旅游 攻略
  状态栏：🔥 正在采集第1个视频: 云南旅游攻略...
  进度条：[2/3] 1/10 视频
  进度：10%
  
  ...

[3/3] 正在采集: 科技 数码
  状态栏：🔥 正在采集第1个视频: iPhone15评测...
  进度条：[3/3] 1/10 视频
  进度：10%
  
  ...
```

**生成文件：**
```
✅ 抖音_美食_探店_评论.csv
✅ 抖音_美食_探店_内容.csv

✅ 抖音_旅游_攻略_评论.csv
✅ 抖音_旅游_攻略_内容.csv

✅ 抖音_科技_数码_评论.csv
✅ 抖音_科技_数码_内容.csv
```

---

## ⚠️ 注意事项

### 1. 文件覆盖问题
- **现象：** 同一关键词多次采集会覆盖之前的文件
- **原因：** 文件名不再包含时间戳
- **建议：** 
  - 采集前备份重要数据
  - 或者手动重命名已有文件
  - 或者使用不同的输出目录

### 2. 关键词特殊字符
- **自动处理：** 空格、斜杠等特殊字符会被替换为下划线
- **示例：**
  ```
  输入：美食/探店 推荐
  文件名：抖音_美食_探店_推荐_评论.csv
  ```

### 3. 进度显示延迟
- **现象：** 进度条可能有1-2秒延迟
- **原因：** 跨线程UI更新机制
- **影响：** 不影响实际采集，仅显示延迟

---

## 🔄 升级指南

### 从 V1.2.0 升级到 V1.2.1

**步骤1：备份数据**
```bash
# 备份现有数据文件
cp -r data data_backup_v120
```

**步骤2：更新代码**
```bash
# 拉取最新代码
git pull origin main
```

**步骤3：重启应用**
```bash
# 重新启动GUI
python gui_app.py
```

**步骤4：验证功能**
- 检查进度条是否实时更新
- 检查文件命名是否符合新规则
- 测试批量关键词采集

---

## 📝 已知问题

### 1. 文件名过长
- **现象：** 关键词过长时，文件名可能超过系统限制
- **建议：** 关键词控制在30字以内

### 2. 进度条跳跃
- **现象：** 进度条可能出现跳跃（如：10% → 30%）
- **原因：** 某些视频采集失败被跳过
- **影响：** 不影响最终结果

---

## 🚀 未来计划

### V1.3.0 规划
- [ ] 支持文件命名模板自定义
- [ ] 支持时间戳可选（避免覆盖）
- [ ] 支持采集进度保存和恢复
- [ ] 支持采集结果预览

---

## 📞 反馈与支持

### 问题反馈
- GitHub Issues: https://github.com/InterestWatcher-Xiaofeng/-/issues
- Email: 158789466+InterestWatcher-Xiaofeng@users.noreply.github.com

---

**祝您使用愉快！** 🎉

