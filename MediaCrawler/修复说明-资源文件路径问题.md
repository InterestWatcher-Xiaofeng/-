# 🔧 资源文件路径问题修复说明

## 📋 问题描述

### 错误信息
```
FileNotFoundError: [Errno 2] No such file or directory: 'libs/douyin.js'
FileNotFoundError: [Errno 2] No such file or directory: 'libs/zhihu.js'
FileNotFoundError: [Errno 2] No such file or directory: 'libs/stealth.min.js'
```

### 根本原因
PyInstaller打包后，程序运行在临时目录（`sys._MEIPASS`），使用硬编码的相对路径无法找到资源文件。

**开发环境 vs 打包环境：**
- **开发环境**：当前工作目录 = 项目根目录，相对路径有效
- **打包环境**：当前工作目录 ≠ 资源文件目录，相对路径失效

---

## ✅ 解决方案

### 1. 创建统一的资源路径工具

**新增文件：** `MediaCrawler/tools/resource_path.py`

```python
def get_resource_path(relative_path: str) -> str:
    """获取资源文件的绝对路径，兼容开发环境和打包后的环境"""
    if getattr(sys, 'frozen', False):
        # 打包后的exe，使用PyInstaller的临时目录
        base_path = sys._MEIPASS
    else:
        # 开发环境，使用项目根目录
        base_path = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
    return os.path.join(base_path, relative_path)

def get_libs_path(filename: str) -> str:
    """获取libs目录下文件的绝对路径"""
    return get_resource_path(f'libs/{filename}')
```

**优势：**
- ✅ 统一管理资源路径
- ✅ 自动适配开发/打包环境
- ✅ 代码简洁易维护
- ✅ 可扩展到其他资源目录

---

## 🔧 修复的文件清单

### 核心修复（9个文件）

#### 1. **tools/resource_path.py** - 新增
资源路径工具模块，提供统一的路径获取方法

#### 2. **media_platform/douyin/help.py**
**问题：** 第28行硬编码 `'libs/douyin.js'`
```python
# ❌ 修复前
douyin_sign_obj = execjs.compile(open('libs/douyin.js', encoding='utf-8-sig').read())

# ✅ 修复后
from tools.resource_path import get_libs_path
douyin_js_path = get_libs_path('douyin.js')
douyin_sign_obj = execjs.compile(open(douyin_js_path, encoding='utf-8-sig').read())
```

#### 3. **media_platform/zhihu/help.py**
**问题：** 第40行硬编码 `"libs/zhihu.js"`
```python
# ❌ 修复前
with open("libs/zhihu.js", mode="r", encoding="utf-8-sig") as f:
    ZHIHU_SGIN_JS = execjs.compile(f.read())

# ✅ 修复后
from tools.resource_path import get_libs_path
zhihu_js_path = get_libs_path("zhihu.js")
with open(zhihu_js_path, mode="r", encoding="utf-8-sig") as f:
    ZHIHU_SGIN_JS = execjs.compile(f.read())
```

#### 4. **media_platform/douyin/core.py**
**问题：** 第79行硬编码 `"libs/stealth.min.js"`
```python
# ❌ 修复前
await self.browser_context.add_init_script(path="libs/stealth.min.js")

# ✅ 修复后
from tools.resource_path import get_libs_path
stealth_js_path = get_libs_path("stealth.min.js")
await self.browser_context.add_init_script(path=stealth_js_path)
```

#### 5. **media_platform/xhs/core.py**
**问题：** 第83行硬编码 `"libs/stealth.min.js"`
```python
# ✅ 修复方式同上
```

#### 6. **media_platform/bilibili/core.py**
**问题：** 第82行硬编码 `"libs/stealth.min.js"`
```python
# ✅ 修复方式同上
```

#### 7. **media_platform/kuaishou/core.py**
**问题：** 第82行硬编码 `"libs/stealth.min.js"`
```python
# ✅ 修复方式同上
```

#### 8. **media_platform/weibo/core.py**
**问题：** 第82行硬编码 `"libs/stealth.min.js"`
```python
# ✅ 修复方式同上
```

#### 9. **tools/cdp_browser.py**
**问题：** 第251行 `add_stealth_script` 方法默认参数使用相对路径
```python
# ❌ 修复前
async def add_stealth_script(self, script_path: str = "libs/stealth.min.js"):
    if self.browser_context and os.path.exists(script_path):
        await self.browser_context.add_init_script(path=script_path)

# ✅ 修复后
from tools.resource_path import get_libs_path

async def add_stealth_script(self, script_path: str = "libs/stealth.min.js"):
    # 如果是相对路径，使用资源路径工具
    if not os.path.isabs(script_path):
        script_path = get_libs_path(os.path.basename(script_path))
    
    if self.browser_context and os.path.exists(script_path):
        await self.browser_context.add_init_script(path=script_path)
```

---

## 📊 修复统计

| 类别 | 数量 | 说明 |
|------|------|------|
| 新增文件 | 1 | resource_path.py |
| 修改文件 | 8 | 各平台core.py + help.py |
| 修复的路径引用 | 10+ | douyin.js, zhihu.js, stealth.min.js |
| 受影响的平台 | 6 | 抖音、小红书、B站、快手、微博、知乎 |

---

## 🎯 修复效果

### 修复前
```
启动EXE
  ↓
加载模块
  ↓
❌ FileNotFoundError: libs/douyin.js
  ↓
程序崩溃
```

### 修复后
```
启动EXE
  ↓
加载模块
  ↓
✅ 自动检测环境（开发/打包）
  ↓
✅ 使用正确的资源路径
  ↓
✅ 成功加载JS文件
  ↓
✅ 程序正常运行
```

---

## 🔍 技术细节

### PyInstaller打包机制

**打包后的目录结构：**
```
临时目录 (_MEIPASS)
├── libs/
│   ├── douyin.js
│   ├── zhihu.js
│   └── stealth.min.js
├── config/
├── media_platform/
└── ... (其他文件)
```

**sys._MEIPASS 示例路径：**
- Windows: `C:\Users\xxx\AppData\Local\Temp\_MEIxxxxxx\`
- 每次运行都会生成新的临时目录

### 路径解析逻辑

```python
# 开发环境
sys.frozen = False
base_path = "C:/Users/xxx/Desktop/MediaCrawler"
resource_path = "C:/Users/xxx/Desktop/MediaCrawler/libs/douyin.js"

# 打包环境
sys.frozen = True
base_path = "C:/Users/xxx/AppData/Local/Temp/_MEI123456"
resource_path = "C:/Users/xxx/AppData/Local/Temp/_MEI123456/libs/douyin.js"
```

---

## 🚀 使用建议

### 对于开发者

1. **添加新资源文件时**
   ```python
   # ❌ 不要这样写
   with open('data/config.json') as f:
       ...
   
   # ✅ 应该这样写
   from tools.resource_path import get_resource_path
   config_path = get_resource_path('data/config.json')
   with open(config_path) as f:
       ...
   ```

2. **扩展资源路径工具**
   ```python
   # 在 resource_path.py 中添加新方法
   def get_data_path(filename: str) -> str:
       """获取data目录下文件的绝对路径"""
       return get_resource_path(f'data/{filename}')
   ```

3. **测试建议**
   - 开发环境测试：`python gui_app.py`
   - 打包环境测试：打包后运行EXE
   - 确保两种环境都能正常运行

### 对于用户

**无需任何操作！**
- ✅ 修复后的程序会自动处理路径问题
- ✅ 开发环境和打包环境都能正常运行
- ✅ 无需手动配置任何路径

---

## 📝 相关文件

### PyInstaller配置
**MediaCrawler-GUI.spec** 已正确配置资源文件：
```python
datas=[
    ('libs', 'libs'),  # ✅ 包含libs目录
    ('config', 'config'),
    ('media_platform', 'media_platform'),
    ...
]
```

### 需要注意的其他路径

以下路径也可能需要类似处理（如果遇到问题）：
- `docs/hit_stopwords.txt` - 停用词文件
- `docs/STZHONGS.TTF` - 中文字体文件
- `config/*.py` - 配置文件
- `browser_data/` - 浏览器数据目录
- `login_data/` - 登录数据目录

---

## 🎉 总结

本次修复通过创建统一的资源路径工具，彻底解决了PyInstaller打包后的资源文件路径问题：

✅ **问题根源**：硬编码相对路径在打包后失效
✅ **解决方案**：动态获取资源路径，适配不同环境
✅ **修复范围**：9个文件，10+处路径引用
✅ **修复效果**：开发和打包环境都能正常运行
✅ **代码质量**：统一管理，易于维护和扩展

现在用户可以直接运行打包后的EXE，不会再遇到资源文件找不到的问题！🎊

---

**修复完成时间：** 2025-10-25
**修复版本：** V1.0.2
**修复作者：** AI Assistant

